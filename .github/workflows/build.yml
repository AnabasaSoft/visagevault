name: Build VisageVault Releases

on:
  release:
    types: [created]

jobs:
  # ========================================================
  # TAREA 1: CONSTRUIR EL .EXE PARA WINDOWS
  # ========================================================
  build-windows:
    runs-on: windows-latest
    # Usar bash para evitar problemas con los caracteres de escape de PowerShell
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install -r requirements.txt
          pip install pyinstaller cmake

      - name: Construir .exe con PyInstaller
        # Usamos \ para salto de linea en bash
        run: |
          pyinstaller --noconfirm \
            --onefile \
            --windowed \
            --name "VisageVault" \
            --add-data "visagevault.png;." \
            --collect-data face_recognition_models \
            --collect-all rawpy \
            --hidden-import piexif \
            --hidden-import numpy \
            --hidden-import sklearn \
            --hidden-import scipy._cyutility \
            --hidden-import sklearn._cyutility \
            visagevault.py

      - name: Subir Windows Asset
        uses: softprops/action-gh-release@v1
        with:
          files: dist/VisageVault.exe
          tag_name: ${{ github.event.release.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false

  # ========================================================
  # TAREA 2: CONSTRUIR EL .DMG PARA MACOS
  # ========================================================
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias (Python y Sistema)
        run: |
          pip install -r requirements.txt
          pip install pyinstaller cmake
          # Instalar create-dmg con Homebrew, no con pip
          brew install create-dmg

      - name: Construir .app con PyInstaller
        run: |
          pyinstaller --noconfirm \
            --onedir \
            --windowed \
            --name "VisageVault" \
            --add-data "visagevault.png:." \
            --collect-data face_recognition_models \
            --collect-all rawpy \
            --hidden-import piexif \
            --hidden-import numpy \
            --hidden-import sklearn \
            --hidden-import scipy._cyutility \
            --hidden-import sklearn._cyutility \
            visagevault.py

      - name: Crear .dmg
        # create-dmg requiere la ruta al .app generado en dist/
        run: |
          # Asegurar que el directorio dist existe y contiene la app
          ls -R dist/
          create-dmg \
            --volname "VisageVault Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "VisageVault.app" 200 190 \
            --hide-extension "VisageVault.app" \
            --app-drop-link 600 185 \
            "VisageVault-macOS.dmg" \
            "dist/VisageVault.app"

      - name: Subir macOS Asset
        uses: softprops/action-gh-release@v1
        with:
          files: VisageVault-macOS.dmg
          tag_name: ${{ github.event.release.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false

  # ========================================================
  # TAREA 3: CONSTRUIR PAQUETES DE LINUX
  # ========================================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias del sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libopenblas-dev liblapack-dev \
            ffmpeg qt6-base-dev ruby-dev
          sudo gem install fpm

      - name: Configurar linuxdeploy
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Instalar dependencias Python
        run: pip install -r requirements.txt

      - name: Construir binario con PyInstaller
        run: |
          pip install pyinstaller
          pyinstaller --noconfirm \
            --onedir \
            --windowed \
            --name "VisageVault" \
            --add-data "visagevault.png:." \
            --collect-data face_recognition_models \
            --collect-all rawpy \
            --hidden-import piexif \
            --hidden-import numpy \
            --hidden-import sklearn \
            --hidden-import scipy._cyutility \
            --hidden-import sklearn._cyutility \
            visagevault.py

      - name: Empaquetar AppDir
        run: |
          # Crear estructura
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copiar binarios (todo el contenido de dist/VisageVault)
          cp -r dist/VisageVault/* AppDir/usr/bin/

          # Asegurar permisos de ejecución
          chmod +x AppDir/usr/bin/VisageVault

          # Copiar icono
          cp visagevault.png AppDir/usr/share/icons/hicolor/256x256/apps/visagevault.png
          cp visagevault.png AppDir/visagevault.png

          # Crear .desktop
          cat << EOF > AppDir/usr/share/applications/visagevault.desktop
          [Desktop Entry]
          Name=VisageVault
          Comment=Gestor de Fotografias Inteligente
          Exec=VisageVault
          Icon=visagevault
          Type=Application
          Categories=Graphics;Photography;
          Terminal=false
          EOF

          # Copia también en raiz para linuxdeploy (por si acaso)
          cp AppDir/usr/share/applications/visagevault.desktop AppDir/

      - name: Generar AppImage
        run: |
          # Forzar el entorno para que linuxdeploy encuentre el ejecutable
          export LINUXDEPLOY_OUTPUT_VERSION="${{ github.event.release.tag_name }}"

          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable AppDir/usr/bin/VisageVault \
            --desktop-file AppDir/usr/share/applications/visagevault.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/visagevault.png \
            --output appimage

      - name: Generar paquetes DEB/RPM/PKG
        run: |
          VERSION_TAG=$(echo ${{ github.event.release.tag_name }} | sed 's/v//')

          # DEB
          fpm -s dir -t deb -n visagevault -v $VERSION_TAG \
            --architecture amd64 \
            --description "Gestor de Fotos y Vídeos Inteligente" \
            --maintainer "Daniel Serrano" \
            --url "https://github.com/danitxu79/VisageVault" \
            --depends python3 \
            -C AppDir \
            --prefix "/"

          # RPM
          fpm -s dir -t rpm -n visagevault -v $VERSION_TAG \
            --architecture x86_64 \
            --description "Gestor de Fotos y Vídeos Inteligente" \
            --maintainer "Daniel Serrano" \
            --url "https://github.com/danitxu79/VisageVault" \
            --depends python3 \
            -C AppDir \
            --prefix "/"

          # PACMAN
          fpm -s dir -t pacman -n visagevault -v $VERSION_TAG \
            --architecture x86_64 \
            --description "Gestor de Fotos y Vídeos Inteligente" \
            --maintainer "Daniel Serrano" \
            --url "https://github.com/danitxu79/VisageVault" \
            --depends python \
            -C AppDir \
            --prefix "/"

      - name: Subir Linux Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.AppImage
            *.deb
            *.rpm
            *.pkg.tar.zst
          tag_name: ${{ github.event.release.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false

name: Build VisageVault Releases

# Se activa cuando creas un "Release" en GitHub
on:
  release:
    types: [created]

jobs:
  # ========================================================
  # TAREA 1: CONSTRUIR EL .EXE PARA WINDOWS
  # ========================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - name: 1. Descargar el código fuente
        uses: actions/checkout@v4

      - name: 2. Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. Instalar dependencias de Python
        run: |
          pip install -r requirements.txt
          pip install pyinstaller cmake

      - name: 4. Ejecutar PyInstaller (para Windows .exe)
        run: |
          pyinstaller --noconfirm ^
            --onefile ^
            --windowed ^
            --name VisageVault ^
            --add-data="visagevault.png;." ^
            --collect-data face_recognition_models ^
            --collect-all=rawpy ^  # Asegura binarios de RAW
            --hidden-import=piexif ^ # Asegura import de EXIF
            --hidden-import=numpy ^
            --hidden-import=sklearn ^
            --hidden-import=scipy._cyutility ^
            --hidden-import=sklearn._cyutility ^
            visagevault.py

      - name: 5. Subir el ejecutable a la Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/VisageVault.exe
          tag_name: ${{ github.event.release.tag_name }}
          # Usamos github.event.release.tag_name que contiene el tag (ej. v1.2.0)
          # draft: true  # Descomentar si quieres que la release se quede en borrador

  # ========================================================
  # TAREA 2: CONSTRUIR EL .DMG PARA MACOS
  # ========================================================
  build-macos:
    runs-on: macos-latest
    steps:
      - name: 1. Descargar el código fuente
        uses: actions/checkout@v4

      - name: 2. Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. Instalar dependencias de Python
        run: |
          pip install -r requirements.txt
          pip install pyinstaller cmake create-dmg

      - name: 4. Ejecutar PyInstaller (para macOS .app)
        run: |
          pyinstaller --noconfirm \
            --onedir \
            --windowed \
            --name VisageVault \
            --add-data="visagevault.png:." \
            --collect-data face_recognition_models \
            --collect-all=rawpy \
            --hidden-import=piexif \
            --hidden-import=numpy \
            --hidden-import=sklearn \
            --hidden-import=scipy._cyutility \
            --hidden-import=sklearn._cyutility \
            visagevault.py

      - name: 5. Crear el .dmg (Imagen de Disco)
        # Asume que PyInstaller creó VisageVault.app dentro de dist/
        run: create-dmg "dist/VisageVault.app"

      - name: 6. Subir el .dmg a la Release
        uses: softprops/action-gh-release@v1
        with:
          files: VisageVault*.dmg
          tag_name: ${{ github.event.release.tag_name }}
          # draft: true

  # ========================================================
  # TAREA 3: CONSTRUIR PAQUETES DE LINUX (AppImage, .deb, .rpm, .pkg)
  # ========================================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Descargar el código fuente
        uses: actions/checkout@v4

      - name: 2. Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3. Instalar dependencias del sistema (dev, qt, ffmpeg, fpm)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libopenblas-dev liblapack-dev \
            ffmpeg qt6-base-dev ruby-dev
          sudo gem install fpm

      - name: 4. Descargar linuxdeploy
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: 5. Instalar dependencias de Python
        run: pip install -r requirements.txt

      - name: 6. Ejecutar PyInstaller (para Linux, modo --onedir)
        run: |
          pip install pyinstaller
          pyinstaller --noconfirm \
            --onedir \
            --windowed \
            --name VisageVault \
            --add-data="visagevault.png:." \
            --collect-data face_recognition_models \
            --collect-all=rawpy \
            --hidden-import=piexif \
            --hidden-import=numpy \
            --hidden-import=sklearn \
            --hidden-import=scipy._cyutility \
            --hidden-import=sklearn._cyutility \
            visagevault.py

      - name: 7. Crear AppDir y .desktop
        # Este paso es necesario para AppImage y fpm.
        run: |
          mkdir -p AppDir/usr/bin
          cp -r dist/VisageVault/* AppDir/usr/bin/
          cp visagevault.png AppDir/

          # Crear .desktop file
          cat << EOF > AppDir/visagevault.desktop
          [Desktop Entry]
          Name=VisageVault
          Comment=Gestor de Fotografías Inteligente
          Exec=usr/bin/VisageVault
          Icon=visagevault
          Type=Application
          Categories=Graphics;Photography;
          EOF

      - name: 8. Ejecutar linuxdeploy (para .AppImage)
        run: |
          ./linuxdeploy-x86_64.AppImage --appdir AppDir \
            --desktop-file AppDir/visagevault.desktop \
            --icon-file AppDir/visagevault.png \
            --output appimage

      - name: 9. Crear paquetes DEB/RPM/PKG (Usando fpm)
        # Creamos los paquetes a partir del directorio AppDir/usr/bin/
        run: |
          VERSION_TAG=$(echo ${{ github.event.release.tag_name }} | sed 's/v//')

          # 9a. DEBIAN (.deb)
          fpm -s dir -t deb -n visagevault -v $VERSION_TAG \
            --architecture amd64 \
            --description "Gestor de Fotos y Vídeos Inteligente" \
            --maintainer "Daniel Serrano" \
            --url "https://github.com/danitxu79/VisageVault" \
            -C AppDir \
            --prefix "/"

          # 9b. RPM (Fedora)
          fpm -s dir -t rpm -n visagevault -v $VERSION_TAG \
            --architecture x86_64 \
            --description "Gestor de Fotos y Vídeos Inteligente" \
            --maintainer "Daniel Serrano" \
            --url "https://github.com/danitxu79/VisageVault" \
            -C AppDir \
            --prefix "/"

          # 9c. PACMAN (.pkg.tar.zst para Arch/Manjaro)
          fpm -s dir -t pacman -n visagevault -v $VERSION_TAG \
            --architecture x86_64 \
            --description "Gestor de Fotos y Vídeos Inteligente" \
            --maintainer "Daniel Serrano" \
            --url "https://github.com/danitxu79/VisageVault" \
            -C AppDir \
            --prefix "/"

      - name: 10. Subir todos los Assets de Linux a la Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.AppImage
            *.deb
            *.rpm
            *.pkg.tar.zst
          tag_name: ${{ github.event.release.tag_name }}
          # draft: true
